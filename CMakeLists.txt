cmake_minimum_required(VERSION 3.10)
project(AdderTemplate NONE)

# Options/Variables
set(TOP_NAME "adder_tb_top" CACHE STRING "Specify the top module name")
set(TEST_NAME "adder_basic_test" CACHE STRING "Specify the test name")
set(VIVADO_PARMS "--R" CACHE STRING "Pass extra Vivado parameters for xsim (e.g. --R)")

# Xilinx environment validation
if(NOT DEFINED ENV{XILINX_VIVADO})
    message(WARNING "XILINX_VIVADO environment variable is not set. Ensure you have sourced settings64.sh!")
endif()

# Fetch source list paths from srclist2path.sh
execute_process(
    COMMAND bash "${CMAKE_SOURCE_DIR}/bin/srclist2path.sh" "${CMAKE_SOURCE_DIR}/srclist/${TOP_NAME}.srclist"
    OUTPUT_VARIABLE SRCLIST_PATHS
    OUTPUT_STRIP_TRAILING_WHITESPACE
)

# Convert bash space-separated string to CMake list
separate_arguments(SRCLIST_PATHS_LIST UNIX_COMMAND "${SRCLIST_PATHS}")

# Convert VIVADO_PARMS so that multiple spaces/args aren't grouped as a single string
separate_arguments(VIVADO_PARMS_LIST UNIX_COMMAND "${VIVADO_PARMS}")

message(STATUS "--------------------------------------------------")
message(STATUS "  Simulation Configuration:")
message(STATUS "  - Top Module     : ${TOP_NAME}")
message(STATUS "  - Test Name      : ${TEST_NAME}")
message(STATUS "  - Vivado Params  : ${VIVADO_PARMS}")
message(STATUS "--------------------------------------------------")

# Compile target
add_custom_target(compile
    COMMAND xvlog -L uvm -sv "$ENV{XILINX_VIVADO}/data/system_verilog/uvm_1.2/uvm_macros.svh" ${SRCLIST_PATHS_LIST}
    WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
    COMMENT "Compiling SystemVerilog and UVM sources..."
    VERBATIM
)

# Elaborate target
add_custom_target(elaborate
    COMMAND xelab ${TOP_NAME} --timescale 1ns/1ps -L uvm -s top_sim --debug typical --mt 16 --incr
    DEPENDS compile
    WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
    COMMENT "Elaborating design..."
    VERBATIM
)

# Sim target (default simulation task with provided parameters)
add_custom_target(sim
    COMMAND xsim top_sim ${VIVADO_PARMS_LIST} --testplusarg UVM_TESTNAME=${TEST_NAME}
    DEPENDS elaborate
    WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
    COMMENT "Running standard simulation..."
    USES_TERMINAL
)

# GUI target (forces GUI mode and automatically includes standard wcfg if available)
add_custom_target(gui
    COMMAND xsim top_sim --gui --view ${TOP_NAME}_sim.wcfg --testplusarg UVM_TESTNAME=${TEST_NAME}
    DEPENDS elaborate
    WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
    COMMENT "Opening simulation in Vivado GUI..."
    USES_TERMINAL
)

# Clean extra Vivado generated files
# CMake's default `make clean` doesn't know about files generated by Vivado commands.
set_directory_properties(PROPERTIES ADDITIONAL_CLEAN_FILES 
    "xsim.dir;xvlog.log;xvlog.pb;xelab.log;xelab.pb;xsim.log;xsim.jou;webtalk_pn.xml;webtalk.jou;xsim_webtalk.tcl"
)
